import base64
import io
import requests
from PIL import Image
import numpy as np
import torch


def pil_to_tensor(img: Image.Image):
    arr = np.array(img).astype(np.float32) / 255.0
    if arr.ndim == 2:  # если ч/б
        arr = np.stack([arr, arr, arr], axis=-1)
    # -> [1, H, W, 3]
    return torch.from_numpy(arr)[None, ...]


class NanoBananaChat:
    """
    Нод, который отправляет текстовый промпт в Nano Banana API
    и возвращает картинку как IMAGE для ComfyUI.
    """

    def __init__(self):
        pass

    @classmethod
    def INPUT_TYPES(cls):
        return {
            "required": {
                "prompt": ("STRING", {
                    "multiline": True,
                    "default": "a heroic warrior in dark fantasy armor, dramatic lighting",
                }),
                "aspect_ratio": ("STRING", {
                    "default": "16:9",
                    "multiline": False,
                }),
            },
        }

    RETURN_TYPES = ("IMAGE",)
    RETURN_NAMES = ("image",)
    FUNCTION = "generate"
    CATEGORY = "NanoBanana"

    # --- ВАЖНО ---
    # Вставь сюда свои реальные данные:
    API_URL = "https://YOUR_NANOBANANA_ENDPOINT"   # пример: https://gemini-2-5-flash-image-api.p.rapidapi.com/nano-banana
    API_KEY = "YOUR_API_KEY_HERE"

    def call_nanobanana_api(self, prompt: str, aspect_ratio: str) -> Image.Image:
        """
        Пример вызова API. Перед отправкой обязательно
        сверяйся с документацией выбранного провайдера Nano Banana.
        """

        headers = {
            "Content-Type": "application/json",
            # примеры — поменяй под своего провайдера:
            # "x-rapidapi-host": "gemini-2-5-flash-image-api.p.rapidapi.com",
            # "x-rapidapi-key": self.API_KEY,
            "Authorization": f"Bearer {self.API_KEY}",  # или другой способ, зависит от сервиса
        }

        data = {
            "prompt": prompt,
            # имя параметра тоже зависит от API; у некоторых это image_size, у других image_config и т.п.
            "image_size": aspect_ratio,   # пример: "16:9", "1:1"
        }

        resp = requests.post(self.API_URL, json=data, headers=headers, timeout=120)
        resp.raise_for_status()
        result = resp.json()

        # Дальше нужно разобрать ответ. Часто API возвращает base64-картинку.
        # Ниже — ОБЩИЙ пример, точно проверь в документации.

        # допустим, result["image_base64"] — это строка с данными
        b64 = result["image_base64"]
        img_bytes = base64.b64decode(b64)
        img = Image.open(io.BytesIO(img_bytes)).convert("RGB")
        return img

    def generate(self, prompt, aspect_ratio):
        img = self.call_nanobanana_api(prompt, aspect_ratio)
        tensor = pil_to_tensor(img)
        return (tensor,)


NODE_CLASS_MAPPINGS = {
    "NanoBananaChat": NanoBananaChat,
}

NODE_DISPLAY_NAME_MAPPINGS = {
    "NanoBananaChat": "Nano Banana Chat",
}
